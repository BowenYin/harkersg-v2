<!DOCTYPE html>
<html ng-app="App" lang="en">
<head>
	<base href="/">
	<title ng-bind="tabName"></title>
	<meta charset="utf-8">
	<meta name="keywords" content="HarkerSG, harker school, bowenyin.tk, harker study guides, study guides, Harker, app.bowenyin.tk">
	<meta name="description" content="Student-contributed notes and study guides for Harker School courses.">
	<meta name="author" content="Bowen Yin">
	<meta name="viewport" content="width=device-width">
	<link rel="shortcut icon" href="/images/favicon.png">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,400italic">
	<link rel="stylesheet" type="text/css" href="/angular-material.css">
	<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
	<meta name="google-signin-client_id" content="978510109102-3mompmb5s816pld0anjl213h1rqoldcn.apps.googleusercontent.com">
	<meta name="google-signin-cookiepolicy" content="single_host_origin">
	<meta name="google-signin-scope" content="profile email">
</head>
<body ng-controller="MainControl as ctrl" layout="row" ng-cloak>
	<md-sidenav md-component-id="left" class="md-sidenav-left" md-whiteframe="5">
		<md-list-item hide-gt-xs class="md-2-line" id="user-info-l" flex="none" layout-align="end center" style="display: none;">
			<img id="profile-pic-l" alt="avatar" class="md-avatar" src="/images/profile-pic.jpg">
			<div class="md-list-item-text">
				<h3 id="user-name-l"></h3>
				<h4>{{flags}} flag<span ng-if="flags!=1">s</span></h4>
			</div>
			<md-menu class="md-secondary" md-offset="0 55">
				<md-button class="md-icon-button"><md-icon class="material-icons">arrow_drop_down</md-icon></md-button>
				<md-menu-content width="3">
					<md-menu-item>
						<md-button disabled><md-icon>person</md-icon>Profile</md-button>
					</md-menu-item>
					<md-menu-item>
						<md-button ng-href="/settings" ng-click="reset()"><md-icon>settings</md-icon>Settings</md-button>
					</md-menu-item>
					<md-menu-divider></md-menu-divider>
					<md-menu-item>
						<md-button onclick="signOut()"><md-icon>exit_to_app</md-icon>Sign Out</md-button>
					</md-menu-item>
				</md-menu-content>
			</md-menu>
		</md-list-item>
		<md-content>
			<md-list>
				<md-list-item ng-href="/settings" ng-click="toggleLeftMenu(); reset();">
					<div class="md-list-item-content">
						<md-icon layout-padding>settings</md-icon>
						<span>Settings</span>
					</div>
				</md-list-item>
				<md-list-item ng-href="/ads" ng-click="toggleLeftMenu(); reset();">
					<div class="md-list-item-content">
						<md-icon layout-padding>forum</md-icon>
						<span>Advertisements</span>
					</div>
				</md-list-item>
			</md-list>
			<div layout-padding layout-margin>
				<code>v2.0</code>
				<div align="center" id="copyright" class="md-button"><md-icon>code</md-icon> 2018 by Bowen Yin</div>
			</div>
		</md-content>
	</md-sidenav>
	<div flex layout="column">
		<md-toolbar class="md-whiteframe-4dp">
			<div class="md-toolbar-tools">
				<md-button class="md-icon-button" aria-label="menu" ng-click="toggleLeftMenu()">
					<md-icon>menu</md-icon>
				</md-button>
				<md-truncate flex>{{pageTitle}}</md-truncate>
				<!--<iframe src="//cdn.bannersnack.com/iframe/rotator.html?hash=b769a64b26803d430317234cr1439134&t=1509854674&env=live&wmode=opaque" width="468" height="60" seamless="seamless" scrolling="no" frameborder="0" allowtransparency="true"></iframe>-->
				<md-list-item hide-xs class="md-2-line" id="user-info-r" flex="none" layout-align="end center" style="display: none;">
					<img id="profile-pic-r" alt="avatar" class="md-avatar" src="/images/profile-pic.jpg">
					<div class="md-list-item-text">
						<h3 id="user-name-r"></h3>
						<h4>{{flags}} flag<span ng-if="flags!=1">s</span></h4>
					</div>
					<md-menu class="md-secondary" md-offset="0 55">
						<md-button class="md-icon-button">
							<md-icon class="material-icons">arrow_drop_down</md-icon>
						</md-button>
						<md-menu-content width="3">
							<md-menu-item>
								<md-button disabled><md-icon>person</md-icon>Profile</md-button>
							</md-menu-item>
							<md-menu-item>
								<md-button ng-href="/settings" ng-click="reset()"><md-icon>settings</md-icon>Settings</md-button>
							</md-menu-item>
							<md-menu-divider></md-menu-divider>
							<md-menu-item>
								<md-button onclick="signOut()"><md-icon>exit_to_app</md-icon>Sign Out</md-button>
							</md-menu-item>
						</md-menu-content>
					</md-menu>
				</md-list-item>
				<div id="sign-in" class="g-signin2 md-button" data-width="100" data-onsuccess="onSignIn"></div>
			</div>
			<md-nav-bar aria-label="nav-bar" md-selected-nav-item="navItem" style="overflow-x: scroll;">
				<md-nav-item md-nav-href="/" name="home">Home</md-nav-item>
				<md-nav-item md-nav-href="/about" name="about">About</md-nav-item>
				<md-nav-item md-nav-href="/studyguides" name="studyguides">Study Guides</md-nav-item>
				<md-nav-item md-nav-href="/feedback" name="feedback">Feedback</md-nav-item>
			</md-nav-bar>
		</md-toolbar>
		<section flex ng-view layout="row" ng-cloak></section>
	</div>
	<script async src="https://www.google-analytics.com/analytics.js"></script>
	<script async src="/scripts/autotrack.js"></script>
	<script>
		window.ga=window.ga || function() {(ga.q=ga.q || []).push(arguments)}; ga.l=+new Date;
		ga('create','UA-77014825-5','auto');
		ga('require','maxScrollTracker');
		ga('require','outboundLinkTracker');
		ga('require','urlChangeTracker');
		ga('require','pageVisibilityTracker');
		ga('send','pageview');
	</script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://apis.google.com/js/platform.js" async defer></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular-animate.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular-sanitize.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular-aria.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular-route.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular-messages.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.8/angular-material.min.js"></script>
	<script src="/__/firebase/4.13.0/firebase.js"></script>
	<script src="/__/firebase/4.13.0/firebase-app.js"></script>
	<script src="/__/firebase/4.13.0/firebase-auth.js"></script>
	<script src="/__/firebase/4.13.0/firebase-database.js"></script>
	<!--<script src="/__/firebase/4.13.0/firebase-messaging.js"></script>-->
	<!--<script src="/__/firebase/4.13.0/firebase-storage.js"></script>-->
	<script src="/__/firebase/4.13.0/firebase-firestore.js"></script>
	<script src="/__/firebase/4.13.0/firebase-functions.js"></script>
	<script src="/__/firebase/init.js"></script>
	<script src="/scripts/firebase.js"></script>
	<script>
		var config={
			apiKey: "AIzaSyDvbUDSwqXI2mcfPRDKl1Z3OA5EpCCf0YE",
			authDomain: "bowenyin-tk.firebaseapp.com",
			databaseURL: "https://bowenyin-tk.firebaseio.com",
			projectId: "bowenyin-tk",
			storageBucket: "bowenyin-tk.appspot.com",
			messagingSenderId: "978510109102"
		};
		firebase.initializeApp(config);
	</script>
	<script type="text/javascript">
		var app=angular.module("App", ["ngMaterial","ngMessages","ngRoute","ngSanitize"]);
		app.controller("MainControl", function($scope, $mdSidenav, $mdDialog) {
			$scope.settings=[];
			$scope.email="";
			$scope.toggleLeftMenu=function() {
				$mdSidenav("left").toggle();
			};
			$scope.toggleRightMenu=function() {
				$mdSidenav("right").toggle();
			};
			$scope.reset=function() {
				$scope.navItem=null;
			};
			auth.onAuthStateChanged(function(user) {
				if (user) {
					$scope.signedIn=true;
					$scope.uid=user.uid;
					$scope.allowed=auth.currentUser.email.match(/(@harker.org|@staff.harker.org|@students.harker.org)/);
					document.getElementById("user-info-l").style.display="";
					document.getElementById("user-info-r").style.display="";
					document.getElementById("sign-in").style.display="none";
					document.getElementById("profile-pic-l").src=auth.currentUser.photoURL || "/images/profile-pic.jpg";
					document.getElementById("profile-pic-r").src=auth.currentUser.photoURL || "/images/profile-pic.jpg";
					document.getElementById("user-name-l").innerText=auth.currentUser.displayName.substring(0, auth.currentUser.displayName.indexOf(" ")+2)+".";
					document.getElementById("user-name-r").innerText=auth.currentUser.displayName.substring(0, auth.currentUser.displayName.indexOf(" ")+2)+".";
					fs.collection("users").doc($scope.uid).onSnapshot(function(doc) {
						if (doc!=null) {
							var data=doc.data();
							$scope.fbNo=(new Date())-data.lastFb<3600000;
							$scope.flags=data.flags;
							$scope.settings=data.settings;
							$scope.$apply();
							fs.collection("subjects").onSnapshot(function(querySnapshot) {
								$scope.subjects=[];
								var i=0;
								querySnapshot.forEach(function(doc) {
									if ($scope.settings.subjects==undefined)
										$scope.settings.subjects=[];
									if ($scope.settings.subjects.indexOf(doc.id)!=-1) {
										$scope.subjects.splice(i,0,Object.assign({id: doc.id}, doc.data()));
										i++;
									} else
										$scope.subjects.push(Object.assign({id: doc.id}, doc.data()));
								});
								$scope.loaded=true;
								$scope.$apply();
								if ($scope.settings.primary!=undefined)
									document.cookie="primary="+$scope.settings.primary+"; expires=Fri, 31 Dec 9999 12:00:00 UTC";
								if ($scope.settings.accent!=undefined)
									document.cookie="accent="+$scope.settings.accent+"; expires=Fri, 31 Dec 9999 12:00:00 UTC";
								if (window.location.pathname=="/studyguides" && document.getElementById("counter").innerText=="--")
									window.location.reload(false);
							});
						}
					});
					if (!$scope.allowed) {
						$mdDialog.show(
							$mdDialog.alert()
								.clickOutsideToClose(false)
								.title("You are not using a school email address")
								.textContent("If you have one, please sign out and switch to it. Otherwise, some features (like adding study guides) will be disabled.")
								.ariaLabel("Non-School Account")
								.ok("Got It")
						);
					}
				} else {
					$scope.signedIn=false;
					$scope.allowed=false;
					$scope.loaded=true;
				}
			});
			var CURRENT_VERSION=1.1;
			var cookieVersion=0.0;
			if (navigator.cookieEnabled) {
				var cookies=document.cookie.split("; ");
				for (var i=0; i<cookies.length; i++)
					if (cookies[i].split("=")[0]=="latestVersion") {
						cookieVersion=parseFloat(cookies[i].split("=")[1]);
						break;
					}
			} else
				cookieVersion=100.0;
			if (cookieVersion<CURRENT_VERSION) {
				$mdDialog.show(
					$mdDialog.alert()
						.clickOutsideToClose(false)
						.title("New Features in Version 1.1")
						.htmlContent("<b>PIN TO TOP:</b> You can pin specific subjects to the top by clicking the checkbox at the right side.<br><b>TEACHERS:</b> You can add teachers to any study guide using the plus button.<br><b>SETTINGS:</b> Theme colors and dark mode are now available on the Settings page (click on your profile name).<br><b>SG COUNTER:</b> The SG counter now shows the number of new study guides since your last visit.<br><br>Please use the feedback form if you have any suggestions or issues.")
						.ok("Got It")
				).then(function() {
					document.cookie="latestVersion="+CURRENT_VERSION.toString()+"; expires=Fri, 31 Dec 9999 12:00:00 UTC";
				});
			}
		});
		var cookies=document.cookie.split("; ");
		var primary="blue", accent="orange";
		for (var i=0; i<cookies.length; i++) {
			if (cookies[i].split("=")[0]=="dark" && cookies[i].split("=")[1]=="true") {
				app.config(function($mdThemingProvider) {
					$mdThemingProvider.theme("default").dark();
				});
			}
			else if (cookies[i].split("=")[0]=="primary")
				primary=cookies[i].split("=")[1];
			else if (cookies[i].split("=")[0]=="accent")
				accent=cookies[i].split("=")[1];
		}
		app.config(function($mdThemingProvider) {
			$mdThemingProvider.theme("default").primaryPalette(primary,{"default": "700"}).accentPalette(accent);
			$mdThemingProvider.enableBrowserColor();
		});
		app.config(function($locationProvider, $routeProvider) {
			$routeProvider
				.when("/", {templateUrl: "home.html", controller: "HomeControl"})
				.when("/studyguides", {templateUrl: "studyguides.html", controller: "SGControl"})
				.when("/notes", {redirectTo: "/studyguides"})
				.when("/sg", {redirectTo: "/studyguides"})
				.when("/settings", {templateUrl: "settings.html", controller: "SettingsControl"})
				.when("/about", {templateUrl: "about.html", controller: "AboutControl"})
				.when("/feedback", {templateUrl: "feedback.html", controller: "FeedbackControl"})
				.when("/ads", {templateUrl: "submit.html", controller: "AdsControl"})
				.otherwise({template: "<md-content layout-margin>404 Page Not Found :(</md-content>", controller: "NFControl"});
			$locationProvider.hashPrefix("");
			$locationProvider.html5Mode(true);
		});
	</script>
	<script src="/scripts/main.js"></script>
	<script src="/scripts/studyguides.js"></script>
	<style>
		#copyright:hover {
			background-color: transparent;
			cursor: default;
		}
	</style>
</body>
</html>